name: Shaili-AI Continuous Integration

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: 3.12.0
  NODE_VERSION: 20.x

jobs:
  lint-and-format:
    name: Lint, Format, and Test
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Configurar Python
    - name: Set up Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    # Configurar Node.js
    - name: Set up Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'interface/web/frontend/package-lock.json'
    
    # Instalar dependencias de Python
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install flake8 pytest black isort
      env:
        HF_HOME: ${{ github.workspace }}/.cache/huggingface
    
    # Formateo de código Python con Black
    - name: Format Python code with Black
      run: |
        black --check .
    
    # Ordenamiento de imports con isort
    - name: Sort Python imports with isort
      run: |
        isort --check .
    
    # Linting de Python con Flake8
    - name: Lint Python code with Flake8
      run: |
        flake8 .
    
    # Instalar dependencias de Node
    - name: Install Node dependencies
      run: |
        cd interface/web/frontend
        npm ci
    
    # Formateo de código TypeScript
    - name: Format TypeScript with Prettier
      run: |
        cd interface/web/frontend
        npm run format:check
    
    # Linting de TypeScript/React
    - name: Lint frontend
      run: |
        cd interface/web/frontend
        npm run lint
    
    # Pruebas de backend
    - name: Backend Tests
      run: |
        pytest tests/
    
    # Pruebas de frontend
    - name: Frontend Tests
      run: |
        cd interface/web/frontend
        npm test -- --coverage
    
    # Construcción de frontend
    - name: Build Frontend
      run: |
        cd interface/web/frontend
        npm run build
    
    # Cargar cobertura de código
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./interface/web/frontend/coverage/lcov.info
        flags: frontend
        fail_ci_if_error: true
    
    # Ejecutar benchmarks de rendimiento
    - name: Performance Benchmarks
      run: |
        python scripts/performance_benchmark.py
    
    # Cargar artefacto de informe de rendimiento
    - name: Upload Performance Report
      uses: actions/upload-artifact@v3
      with:
        name: performance-report
        path: performance_report.json
        retention-days: 30
    
    # Notificación de Slack
    - name: Slack Notification
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        fields: repo,message,commit,author,action,eventName,ref,workflow
        text: Resultado del workflow de Shaili-AI
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    # Notificación de Slack personalizada
    - name: Custom Slack Notification
      if: always()
      run: |
        pip install requests
        export CI_STATUS=${{ job.status }}
        python scripts/slack_notification.py
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  integration-tests:
    name: Integration Tests
    needs: lint-and-format
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Configurar entorno de pruebas
    - name: Set up Docker Compose
      run: |
        docker-compose -f docker-compose.yml -f docker-compose.test.yml up -d
    
    # Ejecutar pruebas de integración
    - name: Run Integration Tests
      run: |
        docker-compose exec -T backend python tests/integration_tests.py
    
    # Detener servicios
    - name: Stop Services
      run: |
        docker-compose down

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    # Escaneo de dependencias con Snyk
    - name: Run Snyk to check for vulnerabilities
      uses: snyk/actions/python@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        command: test
    
    # Escaneo de contenedores
    - name: Scan Docker images
      uses: anchore/scan-action@v3
      with:
        image: "shaili-ai-backend:latest,shaili-ai-frontend:latest"

  release-candidate:
    name: Create Release Candidate
    needs: [lint-and-format, integration-tests, security-scan]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    # Generar número de versión
    - name: Generate Version
      id: version
      run: |
        VERSION=$(date +'%Y.%m.%d').${{ github.run_number }}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
    
    # Crear release
    - name: Create Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.version }}
        release_name: Release ${{ steps.version.outputs.version }}
        draft: false
        prerelease: true
